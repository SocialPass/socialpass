# Use a Python 3.11 base image from the bullseye tag.
FROM python:3.11

# Set environment variables.
ENV PYTHONUNBUFFERED 1
ENV DJANGO_SETTINGS_MODULE config.settings.production

# Set the working directory to /code/.
WORKDIR /code/

# Create and activate a virtual environment.
RUN python -m venv venv
RUN . venv/bin/activate

# Copy the Python requirements files and the entire codebase.
COPY config/requirements/production.txt config/requirements/base.txt /code/
COPY . /code/

# Update pip and install Python dependencies within the virtual environment.
RUN pip install --upgrade pip
RUN pip install -r production.txt

# Change directory for a specific RUN command.
WORKDIR /code/backend

# Run Django migrations within the virtual environment.
RUN python manage.py migrate

# Specify how to run your Django application using Gunicorn within the virtual environment.
CMD ["gunicorn", "config.wsgi:application", "--worker-tmp-dir", "/dev/shm"]
