# Use a Python 3.11 base image from the bullseye tag.
FROM python:3.11

# Set environment variables.
ENV PYTHONUNBUFFERED 1
ENV DJANGO_SETTINGS_MODULE config.settings.production

# Set the working directory to /app/.
WORKDIR /app/

# Create and activate a virtual environment.
RUN python -m venv venv
RUN . venv/bin/activate

# Copy the Python requirements files to the container.
COPY /backend/config/requirements/production.txt /app/production.txt
COPY /backend/config/requirements/base.txt /app/base.txt

# Copy your entire codebase, including the Django project, to the container.
COPY /backend /app/

# Update pip and install Python dependencies within the virtual environment.
RUN pip install --upgrade pip
RUN pip install -r production.txt

# Change directory for a specific RUN command.
WORKDIR /app/

# Run Django migrations && collectstatic within the virtual environment.
RUN python manage.py migrate
RUN python manage.py collectstatic --no-input

# Specify how to run your Django application using Gunicorn within the virtual environment.
CMD ["gunicorn", "config.wsgi:application", "--worker-tmp-dir", "/dev/shm"]
