{% extends 'bases/base_primary.html' %}
{% load static i18n get_chain_name crispy_forms_tags avoid_view_resubmission %}

{% block head_title %}
{% if request.resolver_match.url_name == 'ticketgate_create' %}Create{% else %}Update{% endif %} Event - SocialPass
{% endblock head_title %}

{% block navbar_breadcrumb %}
{% if url_name == 'ticketgate_create' %}Create{% else %}Update{% endif %} Event
{% endblock %}

{% block wip_event_creation_ux %}
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
{% endblock %}


{% block extra_head %}
  	{{ block.super}}
	<style type="text/css">
		.required-input .form-label::after, label.required-input::after {
  			content: "*";
		}
	</style>

  <style type="text/css">
    /* Copied from soft-ui theme to support gradual transition of template for chain requirements */
    .nav {
      display: flex;
      flex-wrap: wrap;
      padding-left: 0;
      margin-bottom: 0;
      list-style: none;
    }

    .nav-link {
      display: block;
      padding: 0.5rem 1rem;
      color: #2e95b8;
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }

    @media (prefers-reduced-motion: reduce) {
      .nav-link {
        transition: none;
      }
    }

    .nav-link:hover,
    .nav-link:focus {
      color: #24748f;
    }

    .nav-link.disabled {
      color: #6c757d;
      pointer-events: none;
      cursor: default;
    }

    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
    }

    .nav-tabs .nav-link {
      margin-bottom: -1px;
      background: none;
      border: 1px solid transparent;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }

    .nav-tabs .nav-link:hover,
    .nav-tabs .nav-link:focus {
      border-color: #e9ecef #e9ecef #dee2e6;
      isolation: isolate;
    }

    .nav-tabs .nav-link.disabled {
      color: #6c757d;
      background-color: transparent;
      border-color: transparent;
    }

    .nav-tabs .nav-link.active,
    .nav-tabs .nav-item.show .nav-link {
      color: #495057;
      background-color: #fff;
      border-color: #dee2e6 #dee2e6 #fff;
    }

    .nav-tabs .dropdown-menu {
      margin-top: -1px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
  </style>
{% endblock %}


{% block content %}
<script src="{% static 'js/public/checkoutportal-embedded.js' %}"></script>
<script>
	const eventUUID = "{{event.public_id}}"
	const eventStatus = "{{event.status}}"
	var hasChanges = false

	function disallowPublish(){
		console.log("form changed")
		document.getElementById("stage-changes-action").style.display = "block";
		document.getElementById("preview-and-publish-action").style.display = "none";
	}

	window.addEventListener('load', () => {
		let first_error = document.querySelector('.invalid-feedback:not(.persistent)')
		if (first_error){
			first_error.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
		}

		if (eventUUID){
			var frame = new CheckoutPortalWidget(eventUUID)
			frame.eventPortalUrl = "{{event.checkout_portal_url}}"
			frame.mount("eventportal-root")
		}

		if (eventStatus == "Staged"){
			document.getElementById("event-form").addEventListener('change', disallowPublish)
		}

		document.getElementById("event-form").addEventListener('change', () => {
			hasChanges = true
			document.getElementById("form-changes-identifier").innerHTML = "Pending changes";
		})
	})

	function saveAsDraft(){
		document.getElementById("id_is_draft").checked = true
		document.getElementById("id_is_draft").value = 'True'
		fillRequirementsAndSubmitForm()
	}

	function stageChanges(){
		document.getElementById("id_is_draft").checked = false
		document.getElementById("id_is_draft").value = 'False'
		fillRequirementsAndSubmitForm()
	}

	function save(){
		fillRequirementsAndSubmitForm()
	}
</script>

<!-- START MODALS -->
<section>
	<!-- start Event Preview Modal -->
	<div class="modal" tabindex="-1" id="eventportal-modal" aria-labelledby="eventportal-modal-toggle" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content border-transparent ws-600 hs-600 mw-100 mh-100 p-0">
				<button type="button" class="close text-base bg-content" aria-label="Close" data-hm-dismiss="modal">&times;</button>
				<div class="w-100 h-100" id="eventportal-root"></div>
			</div>
		</div>
	</div>
	<!-- end Event Preview Modal -->

	{% if event.id and event.status == 'Staged' %}
	<!-- start Publish Modal -->
	<div class="modal" tabindex="-1" id="publish-modal" aria-labelledby="publish-modal-toggle" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content border-transparent ws-600 mw-100 p-0">
				<button type="button" class="close text-base bg-content" aria-label="Close" data-hm-dismiss="modal">&times;</button>
				<div class="w-100 h-100" id="publish-root">
					<!-- Hero section start -->
					<section>
						<div class="container-xl">
							<div class="row content">
								<!-- Second column start -->
								<div class="col-12 align-self-center">
									<!-- form.instance cover image start -->
									<div class="d-flex align-items-center justify-content-center rounded overflow-hidden pe-none">
										{% if form.instance.cover_image %}
											<!-- Landscape -->
											<img style="height: 130px; width: 100%;" src="{{ form.instance.cover_image.url }}" alt="{{ form.instance.name }} cover image">
										{% else %}
											No cover image was selected.
										{% endif %}
									</div>
									<!-- Event cover image end -->
								</div>
								<!-- Second column end -->
								<!-- First column start -->
								<div class="col-12 align-self-center">
									<h1 class="fsr-1 fw-700 text-strong">
										{{ form.instance.title }}
									</h1>
									<div class="fsr-6 d-flex align-items-center mt-10">
										<div class="ws-25 flex-shrink-0">
											<i class="fa-regular fa-clock"></i>
										</div>
										<div class="ms-10 text-truncate">
											{{ form.instance.start_date }}
										</div>
									</div>
									<div class="fsr-6 d-flex align-items-center mt-10">
										<div class="ws-25 flex-shrink-0">
											<i class="fa-regular fa-location-dot"></i>
										</div>
										<div class="ms-10 text-truncate">
											{{ form.instance.location }}
										</div>
									</div>
								</div>
								<!-- First column end -->
								<form class="form" method="post" action="{% url 'ticketgate_update' view.kwargs.team_pk event.pk %}?action=publish" id="publish-event-form">
									{% csrf_token %}
									<div class="row g-1 justify-content-between mt-20">
										<div class="col-md-6 pe-md-10">
											<h6 class="fs-base-p2 mb-0">
												Schedule for later
											</h6>
											<p class="mt-5 fs-base-n2 text-muted">
												Do you want to schedule this publication for later?
											</p>
											<div class="mt-10">
												<div class="form-check mb-10">
													<input type="checkbox" class="form-check-input" id="schedule-for-later-checkbox" onchange="togglePublishDate()"/>
													<label for="schedule-for-later-checkbox" class="form-check-label">Yes, schedule for later</label>
												</div>
												{{ form.publish_date }}
												<script>
													const togglePublishDate = () => {
														let el = document.getElementById('date')
														if (el.disabled){
															el.disabled = false
														}else{
															el.value = ''
															el.disabled = true
														}
													}
													document.getElementById('date').disabled = true
												</script>
											</div>
										</div>
										<div class="col-md-6 ps-md-10 d-flex flex-column mt-20 mt-md-0">
											<h6 class="fs-base-p2 mb-0">
												Final tips before publication
											</h6>
											<p class="mt-5 fs-base-n2 text-muted">
												A few more tips before you publish:
											</p>
											<div>
												<div class="d-flex align-items-start">
													<i class="fa-regular fa-check me-10 mt-5"></i>
													<span>Customize your Ticket Portal</span>
												</div>
												<div class="d-flex align-items-start mt-10">
													<i class="fa-regular fa-check me-10 mt-5"></i>
													<span>Host the Ticket Portal on your own site</span>
												</div>
											</div>
										</div>
									</div>
									<div class="mt-20">
										<button class="btn btn-secondary btn-lg fs-base btn-block" type="submit">
											<i class="fa-regular fa-party-horn me-5"></i> Publish Event
										</button>
									</div>
								</form>
							</div>
						</div>
					</section>
					<!-- Hero section end -->
				</div>
			</div>
		</div>
	</div>
	<!-- end Publish Modal -->
	{% endif %}

</section>
<!-- END MODALS -->

<!-- Header start -->
<div class="border-bottom hs-md-100">
	<div class="p-content d-flex h-100">
		<div class="align-self-center">
			<h1 class="content-title m-0 fs-base-p6">
				{% if url_name == 'ticketgate_create' %}Create{% else %}Update{% endif %} Event ({{event.status}})
			</h1>
			<p class="text-muted mt-5 mt-5 mb-0 fs-base-n2">
				Use the following form to create/update an event.
			</p>
		</div>
	</div>
</div>
<!-- Header end -->

<!-- Content card start -->
<div class="card rounded-0 border-top-transparent border-start-0 border-end-0 p-0 m-0">
	<!-- Card header start -->
	<div class="px-card py-10 border-bottom">
		<span class="bg-primary-very-light-lm bg-primary-very-dim-dm border-start border-primary border-2 px-10 py-5 fs-base-n2 fw-bold">
			Event Form
		</span>
		<span id="form-changes-identifier" style="margin-left: 20px" class="bg-secondary-very-light-lm bg-secondary-very-dim-dm border-start border-secondary border-2 px-10 py-5 fs-base-n2 fw-bold">
			No changes to apply
		</span>
	</div>
	<!-- Card header end -->

	<div class="row">
		<!-- Form navigation start -->
		<div class="col-lg-5 border-lg-end">
			<div class="p-content position-lg-sticky top-navbar start-0">
				<div>
					<a href="#1-general-info" class="d-inline-flex align-items-center fw-bold link-reset text-decoration-none">
						<strong class="ws-25 hs-25 rounded-circle flex-shrink-0 bg-primary text-white-lm text-dark-dm d-flex align-items-center justify-content-center">1</strong>
						<span class="ms-15">General Information</span>
					</a>
				</div>
				<div class="mt-15">
					<a href="#2-blockchain-requirements" class="d-inline-flex align-items-center fw-bold link-reset text-decoration-none">
						<strong class="ws-25 hs-25 rounded-circle flex-shrink-0 bg-primary text-white-lm text-dark-dm d-flex align-items-center justify-content-center">2</strong>
						<span class="ms-15">Blockchain Requirements</span>
					</a>
				</div>
				<div class="mt-15">
					<a href="#3-tickets" class="d-inline-flex align-items-center fw-bold link-reset text-decoration-none">
						<strong class="ws-25 hs-25 rounded-circle flex-shrink-0 bg-primary text-white-lm text-dark-dm d-flex align-items-center justify-content-center">3</strong>
						<span class="ms-15">Tickets</span>
					</a>
				</div>
				{% if event.pk %}
				<div class="mt-20">
					<button type="button" class="btn btn-block" data-hm-toggle="modal" data-hm-target="eventportal-modal">Preview Event <i class="fa-regular fa-external-link-alt ms-5"></i></button>
				</div>
				{% endif %}
				<div id="event-actions" class="mt-20 row">
					{% if event.status == "Draft" %}
					<div class="col-6 pe-5">
						<button onclick="saveAsDraft()" class="h-100 btn btn-block">Save Draft</button>
					</div>
					<div class="col-6 ps-5">
						<button id="stage-changes-action" onclick="stageChanges()" class="h-100 btn btn-primary btn-block">Stage Changes</button>
					</div>
					{% elif event.status == "Staged" %}
					<div class="col-6 pe-5">
						<button onclick="saveAsDraft()" class="h-100 btn btn-block">Save as Draft</button>
					</div>
					<div class="col-6 ps-5">
						<button id="preview-and-publish-action" data-hm-toggle="modal" data-hm-target="publish-modal"  class="h-100 btn btn-primary btn-block">Preview and Publish</button>
						<button id="stage-changes-action" style="display: none" onclick="stageChanges()" class="h-100 btn btn-primary btn-block">Stage Changes</button>
					</div>
					{% elif event.status == "Scheduled" %}
					<div class="col-6 pe-5">
						<button onclick="save()" class="h-100 btn btn-block">Save Changes</button>
					</div>
					<div class="col-6 ps-5">
						<form action="{% url 'ticketgate_update' view.kwargs.team_pk event.pk %}?action=unpublish" method="POST">
							{% csrf_token %}
							<input class="h-100 btn btn-primary btn-block" type="submit" value="Unschedule"/>
						</form>
					</div>
					{% elif event.status == "Published" %}
					<div class="col-6 pe-5">
						<button onclick="save()" class="h-100 btn btn-block">Save Changes</button>
					</div>
					<div class="col-6 ps-5">
						<form action="{% url 'ticketgate_update' view.kwargs.team_pk event.pk %}?action=unpublish" method="POST">
							{% csrf_token %}
							<input class="h-100 btn btn-primary btn-block" type="submit" value="Unschedule"/>
						</form>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
		<!-- Form navigation end -->

		<!-- Main content start -->
		<div class="col-lg-7">
			<div class="content">
				<!-- Form start -->
				<form class="form" enctype="multipart/form-data" method="post" id="event-form">
					{% csrf_token %}

					{% if form.non_field_errors %}
						<div class="alert alert-danger" role="alert">
							<ul class="invalid-feedback persistent">
								{% for error in form.non_field_errors %}
									<li>{{ error|escape }}</li>
								{% endfor %}
							</ul>
						</div>
					{% endif %}
					{% if form.errors %}
						<div class="alert alert-danger" role="alert">
							<ul class="invalid-feedback persistent">
								{% for error in form.errors %}
									<li>{{ error|escape }}</li>
								{% endfor %}
							</ul>
						</div>
					{% endif %}

					{% for input in form.hidden_fields %}
						{{ input }}
					{% endfor %}
					<div class="d-none" id="hidden-date">
						{{ form.publish_date }}
					</div>
					<!-- General info start -->
					<section>
						<h2 class="fs-base-p6 mb-0 d-flex align-items-center" id="1-general-info">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-solid fa-circle-1"></i>
							</span>
							General Information
						</h2>
						<p class="text-muted fs-base-n2 mt-5">
							Please fill in some general information about your event.
						</p>

						<hr />
						<h3 class="fs-base-p4 mb-0 d-flex align-items-center">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-regular fa-ballot-check"></i>
							</span>
							Basic Information
						</h3>
						<p class="text-muted fs-base-n2 mt-5">
							Name your event and tell event-goers why they should come. Add details that highlight what makes it unique.
						</p>

						<!-- Title start -->
						<div class="required-input">
							{% with form.title as input %}
								{% include 'components/forms_inputs/input.html' %}
							{% endwith %}
						</div>
						<!-- Title end -->

						<!-- Organizer start -->
						{% with input=form.organizer %}
							{% include 'components/forms_inputs/input.html' %}
						{% endwith %}
						<!-- Organizer end -->

						<!-- Category start -->
						<div class="form-group">
							{{form.category|as_crispy_field}}
						</div>
						<!-- Description end -->

						<div class="form-group">
							{{form.tags|as_crispy_field}}
						</div>

						<!-- Description start -->
						{% with form.description as input %}
							{% include 'components/forms_inputs/textarea.html' %}
						{% endwith %}
						<!-- Description end -->

						<!-- Visibility start -->
						<div class="form-group required-input">
							{{form.visibility|as_crispy_field}}
						</div>
						<!-- Visibility end -->

						<hr />
						<h3 class="fs-base-p4 mb-0 d-flex align-items-center">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-regular fa-location-dot"></i>
							</span>
							Location
						</h3>
						<p class="text-muted fs-base-n2 mt-5">
							Help people in the area discover your event and let attendees know where to show up.
						</p>

						<!-- Location start -->
						{% with placeChangedCallback="onPlaceChangedCallback" initialPlace=form.instance.location %}
							<script>
								function onPlaceChangedCallback(place){
									// set UTC offset
									document.getElementById("id_timezone_offset").value = place.utc_offset_minutes
									// WIP - CharField
									document.getElementById("id_location").value = place.name
									// TODO: GeoDjango - set latitude and longitude hidden field
									console.log(place.geometry.location.lat())
									console.log(place.geometry.location.lng())
								}
							</script>

							{% include 'components/forms_inputs/gmaps_location.html' %}
						{% endwith %}
						<!-- Location end -->


						<!-- Date and Time start -->
						<hr />
						<h3 class="fs-base-p4 mb-0 d-flex align-items-center">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-regular fa-calendar-days"></i>
							</span>
							Date and Time
						</h3>
						<p class="text-muted fs-base-n2 mt-5">
							Tell event-goers when your event starts and ends so they can make plans to attend.
						</p>
						<div class="form-group required-input">
							{{form.start_date|as_crispy_field}}
						</div>
						<div class="form-group">
							{{form.end_date|as_crispy_field}}
							<p class="text-muted fs-base-n2 mt-5">
								Leave empty if there is no end date for the event.
							</p>
						</div>
						<!-- Date and Time end -->

						<!-- Cover Image start -->
						<hr />
						<h3 class="fs-base-p4 mb-0 d-flex align-items-center">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-regular fa-calendar-days"></i>
							</span>
							Main Event Image
						</h3>
						<p class="text-muted fs-base-n2 mt-5">
							Use this image to showcase your event. This will be the banner image attendees will se when purchasing the tickets.
						</p>
						<div class="form-group">
							{{form.cover_image|as_crispy_field}}
						</div>
						<!-- Cover Image end -->


					</section>
					<hr />
					<!-- General info end -->

					<!-- Blockchain Requirements start -->
					<section>
						<h2 class="fs-base-p6 mb-0 d-flex align-items-center" id="2-blockchain-requirements">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-solid fa-circle-2"></i>
							</span>
							Blockchain Requirements
						</h2>
						<p class="text-muted fs-base-n2 mt-5">
							Please provide the NFT or SocialToken information required to redeeem or purchase a ticket to your event.
						</p>
						<nav>
							<ul id="nav-requirement" class="nav nav-tabs" role="tablist">
							<div
								type="button"
								onclick="addRequirement()"
								class="nav-link"
							>
								Add requirement
							</div>
							</ul>
						</nav>
						<div class="tab-content p-10" style="border: 1px solid transparent; border-color: #dee2e6; border-top: 0px;" id="tokenRequirementForms">
						<!-- requirements will be added dynamically -->
						</div>
						<hr />
					</section>
					<!-- Blockchain Requirements end -->

					<!-- Tickets start -->
					<section>
						<h2 class="fs-base-p6 mb-0 d-flex align-items-center" id="3-tickets">
							<span class="ws-25 me-10 text-primary">
								<i class="fa-solid fa-circle-3"></i>
							</span>
							Tickets
						</h2>
						<p class="text-muted fs-base-n2 mt-5">
							Coming soon! Sell different tickets for an event.
						</p>
						<hr />

						<!-- Capacity start -->
						{% with input=form.capacity required="required" %}
							{% include 'components/forms_inputs/input.html' %}
						{% endwith %}
						<!-- Capacity end -->

						<!-- Limit Per Person start -->
						{% with input=form.limit_per_person required="required" %}
							{% include 'components/forms_inputs/input.html' %}
						{% endwith %}
						<!-- Limit Per Person end -->
					</section>
					<!-- Tickets end -->
				</form>
				<!-- Form end -->
			</div>
		</div>
		<!-- Main content end -->
	</div>

	<!-- Card footer start -->
	<div class="px-card py-10 border-top text-muted fs-base-n2">
		Please <a href="https://nftylabs.typeform.com/to/A70KW4vo" target="_blank" class="fw-bold">contact us</a> and let us know if you need help creating/updating an event.
	</div>
	<!-- Card footer end -->
</div>
<script>
	// Helper functions to manage addition/removal/submission of requirement forms and nav-tabs

	var requirementsAbsoluteCounter = 0; // this counter keeps track of how many requirements were added in total. Absolute counter is never decremented. It is used to avoid equal IDs after deleting middle requirements.
	var requirementsCounter = 0; // this counter keeps track of how many requirements are in the screen.
	var tokenIdsCounter = []; // each requirement has its own token_id counter, at its index of the array.
	var currentFormId = 0;

	window.onload = function(){
	  // adds the requirement forms from the initial data. This data is passed by the server and stored in the form context.
	  let initialRequirementsData = JSON.parse('{{form.requirements.value|safe}}');

	  if (initialRequirementsData.length > 0){
		for (let requirement of initialRequirementsData){
		  addRequirement(requirement)
		}
	  }
	}

	function addRequirement(initialData = null) {
	  // adds a requirement form to the screen.
	  let list = document.getElementById("nav-requirement").innerHTML;
	  let divId = "requirementDiv-"+requirementsAbsoluteCounter;

	  // add nav-item
	  list +=
		`
		  <li class="nav-item" role="presentation">
			<button
			  type="button"
			  class="nav-link requirement-nav"
			  id="${divId}-tab"
			  data-bs-toggle="pill"
			  data-bs-target="#${divId}"
			  role="tab"
			>
			  Requirement ${requirementsAbsoluteCounter + 1}
			</button>
		  </li>
		`;
	  document.getElementById("nav-requirement").innerHTML = list;

	  // adds form to tab-content
	  tokenIdsCounter.push(0);
	  _createRequirementForm(initialData);
	  requirementsCounter++;
	  requirementsAbsoluteCounter++;

	  // show the added tab and hide the rest
	  let triggerEl = document.getElementById(`${divId}-tab`)
	  let tabTrigger = new bootstrap.Tab(triggerEl)
	  tabTrigger.show()
	}

	function _createRequirementForm(initialData = null){
	  let divId = "requirementDiv-"+requirementsAbsoluteCounter
	  let formId = "requirementForm-"+requirementsAbsoluteCounter
	  let form = document.getElementById("tokenRequirementForms").innerHTML;

	  let new_div = document.createElement("div");
	  new_div.id = divId
	  new_div.className = "tab-pane fade py-3"
	  new_div.role = "tabpanel"
	  new_div.innerHTML = `
		 <div class="d-flex align-items-center py-3 mb-5">
		  <label class="form-label mb-0">Blockchain Requirement ${requirementsAbsoluteCounter + 1}</label>
		  <button class="btn bg-gradient-primary btn-sm ms-auto my-0"
				  onclick="deleteRequirement(${requirementsAbsoluteCounter})"
				  type="button"
				  aria-label="Close">
			Remove requirement
		  </button>
		</div>
		<form id="${formId}" onChange="disallowPublish()">
		  <div class="form-group">
			<label for="blockChainSelect">Blockchain <span class="asteriskField">*</span></label>
			<select class="form-control" id="blockChainSelect-${requirementsAbsoluteCounter}">

			</select>
		  </div>
		  <div class="form-group">
			<label for="networkSelect">Network <span class="asteriskField">*</span></label>
			<select required class="form-control" id="networkSelect-${requirementsAbsoluteCounter}">

			</select>
		  </div>
		  <div class="form-group">
			<label for="assetTypeSelect">Asset Type <span class="asteriskField">*</span></label>
			<select required class="form-control" id="assetTypeSelect-${requirementsAbsoluteCounter}" placeholder="ERC20">

			</select>
		  </div>
		  <div class="form-group">
			<label for="assetAdressInput">Asset Address <span class="asteriskField">*</span></label>
			<input required pattern="^(0x|0X).*$" required type="text" class="form-control" id="assetAdressInput-${requirementsAbsoluteCounter}"
					oninvalid="this.setCustomValidity('Asset Address must start with 0x')"
					oninput="this.setCustomValidity('')">
		  </div>
		  <div class="form-group">
			<label for="requiredAmountInput">Required Amount <span class="asteriskField">*</span></label>
			<input required type="number" class="form-control" id="requiredAmountInput-${requirementsAbsoluteCounter}">
		  </div>
		  <div>
			Token IDs
			<i type="button" onclick="addNewTokenIdToRequirement(${requirementsAbsoluteCounter})" class="fa-regular fa-add"></i>
			|
			<i type="button" onclick="popTokenIdFromRequirement(${requirementsAbsoluteCounter})" class="fa-regular fa-trash-can"></i>
		  </div>
		  <hr/>
		  <div id="tokenIdGroup-${requirementsAbsoluteCounter}" class="d-flex flex-column align-items-start gap-3 mt-2"></div>
		</form>
	  `;
	  document.getElementById("tokenRequirementForms").appendChild(new_div);

	  //fill the options for the selects from the provided choices in the context
	  let requiremtSchema = JSON.parse('{{json_schema|safe}}');
	  let blockchainOptions = JSON.parse('{{BLOCKHAINS_CHOICES|safe}}');
	  let assetTypeOptions = JSON.parse('{{ASSET_TYPES_CHOICES|safe}}');
	  let chainOptions = JSON.parse('{{CHAIN_IDS_CHOICES|safe}}');;

	  let select;

	  select = document.getElementById(`blockChainSelect-${requirementsAbsoluteCounter}`)
	  for (var [key, value] of Object.entries(blockchainOptions)) {
		select.innerHTML +=  `<option value="${key}">${value}</option>`;
	  }

	  select = document.getElementById(`networkSelect-${requirementsAbsoluteCounter}`)
	  for (var [key, value] of Object.entries(chainOptions)) {
		select.innerHTML += `<option value="${key}">${value}</option>`;
	  }

	  select = document.getElementById(`assetTypeSelect-${requirementsAbsoluteCounter}`)
	  for (var [key, value] of Object.entries(assetTypeOptions)) {
		select.innerHTML += `<option value="${key}">${value}</option>`;
	  }

	  if (initialData){
		// fill from initial data
		document.getElementById("blockChainSelect-"+requirementsAbsoluteCounter).value = initialData.blockchain
		document.getElementById("networkSelect-"+requirementsAbsoluteCounter).value = initialData.chain_id
		document.getElementById("assetTypeSelect-"+requirementsAbsoluteCounter).value = initialData.asset_type
		document.getElementById("requiredAmountInput-"+requirementsAbsoluteCounter).value = initialData.amount
		document.getElementById("assetAdressInput-"+requirementsAbsoluteCounter).value = initialData.asset_address

		for (let token_id of initialData.token_id){
		  addNewTokenIdToRequirement(requirementsAbsoluteCounter, token_id)
		}
	  }
	}

	function deleteRequirementForm(requirementIdx) {
	  document.getElementById(`requirementDiv-${requirementIdx}`).remove();
	}

	function deleteRequirement(requirementIdx) {
	  document.getElementById(`requirementDiv-${requirementIdx}-tab`).parentNode.remove(); // remove nav-tab
	  deleteRequirementForm(requirementIdx);
	  // requirementsAbsoluteCounter is not decremented
	  requirementsCounter--;

	  let triggerEl = document.getElementsByClassName('nav-link requirement-nav')[requirementsCounter - 1]
	  let tabTrigger = new bootstrap.Tab(triggerEl)
	  tabTrigger.show()
	}

	function popTokenIdFromRequirement(requirementIdx){
	  document.getElementById(`tokenId-${requirementIdx}-${tokenIdsCounter[requirementIdx] - 1}`).remove();
	  tokenIdsCounter[requirementIdx] = tokenIdsCounter[requirementIdx] - 1;
	}

	function addNewTokenIdToRequirement(requirementIdx, initialData=null){
	  const tokenIdGroupId = 'tokenIdGroup-'+ requirementIdx

	  let list = document.getElementById(tokenIdGroupId);

	  let new_div = document.createElement('div');
	  new_div.id = `tokenId-${requirementIdx}-${tokenIdsCounter[requirementIdx]}`
	  new_div.innerHTML =
		  `
			<label>Token ID ${tokenIdsCounter[requirementIdx]}</label>
			<input type="text" class="form-control d-inline-block w-auto" value="${initialData? initialData : ""}">
			<hr/>
		`;
	  document.getElementById(tokenIdGroupId).appendChild(new_div);
	  tokenIdsCounter[requirementIdx] = tokenIdsCounter[requirementIdx] + 1;
	}

	function fillRequirementsAndSubmitForm(){
	  let requirementsData = []
	  for (let requirementIdx = 0; requirementIdx < requirementsAbsoluteCounter; requirementIdx++){
		let requirementForm = document.getElementById(`requirementForm-${requirementIdx}`)
		if (requirementForm == null){
		  continue
		}

		if (!requirementForm.checkValidity()){
		  let triggerEl = document.getElementById(`requirementDiv-${requirementIdx}-tab`)
		  let tabTrigger = new bootstrap.Tab(triggerEl)
		  tabTrigger.show()
		  location.hash = "#tokenRequirementForms";
		  setTimeout(() => {requirementForm.reportValidity()}, 1000) // schedule validation on queue because tab.show() is async
		  return
		}

		requirementData = {
		  "blockchain": document.getElementById("blockChainSelect-"+requirementIdx).value,
		  "chain_id": parseInt(document.getElementById("networkSelect-"+requirementIdx).value, 10),
		  "asset_type": document.getElementById("assetTypeSelect-"+requirementIdx).value,
		  "amount": parseInt(document.getElementById("requiredAmountInput-"+requirementIdx).value, 10),
		  "asset_address": document.getElementById("assetAdressInput-"+requirementIdx).value,
		  "token_id": []
		}
		for (let token_idx = 0; token_idx < tokenIdsCounter[requirementIdx]; token_idx++){
		  requirementData["token_id"].push(
			parseInt(document.getElementById(`tokenId-${requirementIdx}-${token_idx}`).getElementsByTagName('input')[0].value, 10)
		  )
		}
		requirementsData.push(requirementData)
	  }
	  document.getElementById('id_requirements').value = JSON.stringify(requirementsData);

	  let form = document.getElementById('event-form');
	  if (form.reportValidity()){
		form.submit();
	  }
	}

	const formatter = new Intl.NumberFormat('en-US', {
		style: 'currency',
		currency: 'USD',
		minimumFractionDigits: 2
	})

	document.getElementById('id_capacity').addEventListener('change', function() {
		var capacity = document.getElementById('id_capacity').value;
		fetch("{% url 'ticketgate_price_estimator' view.kwargs.team_pk %}?capacity=" + capacity).then(function(response) {
			return response.json();
		}).then(function(data) {
			document.getElementById('price-placeholder').style.display = 'none';
			document.getElementById('price-calc').style.display = 'block';

			document.getElementById('price-calc-capacity').innerHTML = capacity;
			document.getElementById('price-calc-priceperticket').innerHTML = formatter.format(data.price_per_ticket);
			document.getElementById('price-calc-price').innerHTML = formatter.format(data.price);

		});
	})
</script>
<!-- Content card end -->
{% endblock%}